<!DOCTYPE html>
<html>

    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Game Scripting with Lua Part 1 - Basic Set-up</title>
    <meta name="description" content="Last winter, I spent all my time developing a gameengine in C++. One of the features I spent the mosttime implementing was Lua scripting support. In thispost...">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://yourdomain.com/gamedev/2015/09/04/lua-and-cpp.html">
    <link rel="alternate" type="application/rss+xml" title="fyi." href="http://yourdomain.com/feed.xml" />


    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-52445936-14', 'auto');
        ga('send', 'pageview');

    </script>
</head>


    <body>

        <header class="site-header">

    <div class="wrapper">

        <div class="title-div">
            <a class="site-title" href="/">fyi.</a>
        </div>
    </div>

    <div class="wrapper">
        <nav class="site-nav">
            <a href="#" class="menu-icon">
                <svg viewBox="0 0 18 15">
                <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                </svg>
            </a>

            <div class="trigger">
                
                <!-- Static 'Home' link -->
                <a class="page-link" href="/">Home</a>
                
                
                
                
                
                
                
                
            </div>
        </nav>

    </div>

</header>


        <div class="wrapper">
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- fyi - page - under header -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3632636155475507"
             data-ad-slot="5572041490"
             data-ad-format="auto"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script> 
        </div>

        <div class="page-content">
            <div class="wrapper">
                <div class="post">

    <header class="post-header">
        <div class="buy-coffee-post-header">
            <a href='http://ko-fi.com?i=9152LY80MBJF' target='_blank' class="coffee-link">
                <img style='border:0px' width="150px" src='https://az743702.vo.msecnd.net/cdn/btn1.png' border='0' alt='Buy Me A Coffee at Ko-Fi.com' class="coffee-img"/>
            </a> 
        </div>
        <h1 class="post-title">Game Scripting with Lua Part 1 - Basic Set-up</h1>
        <p class="post-meta">Sep 4, 2015</p>


    </header>

    <article class="post-content">
        <p>Last winter, I spent all my time developing a game
engine in C++. One of the features I spent the most
time implementing was Lua scripting support. In this
post, I will walk you through the setup and obstacles
of setting the scripting stuff up.</p>

<p>This post was originally posted to my old blog, but
is now migrated here with some clean-up here and there.
Without further ado, let’s get cracking!</p>

<h2 id="why-lua-why-not-just-c">Why Lua? Why not just C++?</h2>

<p>At first you may ask: “Why should we use Lua (or any
other scripting language in that metter)? Why not just,
you know, make the whole game in C++?” The answer is,
you absolutely <em>can</em> make the whole game in C++ (or
any other language of your choice), but the thing is,
when you’re making a large-ish game, the time you spend
compiling and re-compiling the code after each adjustment
starts to pile and and takes a lot out of your actual
development time. Sure, there are some ways to mitigate
this (e.g. compiling modules to DLLs and loading them
dynamically during runtime), but it’s sub-optimal, at
least for a hobby programmer.</p>

<p>With Lua and other scripting languages (or rather,
interpreted languages), you don’t have to compile the
code. You just write the scripts and launch your game.
You can also reload scripts during runtime (automatically,
if you wish) and see changes happen in real-time. It’s also
somewhat faster to try things out in a scripting language
and revert back if you didn’t like the results. Adjusting
things like GUI element positions becomes a lot faster
as you can see the results immediately. Also, since Lua and
most other similar languages are dynamically typed, your
code is quite often simpler than C++. In Lua, there’s just
a single data structure called “table”, which is sufficient
enough for just about any scenario - it can be used as a
key-value dictionary, as an array… You can even implement
object-oriented programming with tables when you use them
as prototypes (which is also a common way of doing OOP in
other languages such as Javascript).</p>

<h2 id="foundations-in-c">Foundations in C++</h2>

<p>When creating a game using C++ and Lua, you should create
a really solid foundation in C++ first. Just about everything
that is not game-specific should be done in C++. These include
window management, rendering, physics simulation, audio handling,
asset management and so on. Why? Mainly for performance reasons,
but there’s also the thing of Lua not being able to do all that
stuff for you. Lua itself is just the language and a couple of
utility libraries - nothing more. It’s also an interpreted
language and (in common cases) it runs a tad slower than native
code.</p>

<p>In my case, I wrote the game engine using a set of open source
libraries such as GLFW, GLM and Tecs. For those who are not
familiar with these, let’s do a quick recap: GLFW is an OpenGL
utility library for managing OpenGL contexts, creating windows
and handling user input. GLM is a header-only math library that
works wonderfully with OpenGL. Last, Tecs in an entity-component-system
framework that lets you create light-weight entities and attach
components to them while systems manipulate the components.</p>

<p>In addition to the engine, I wrote a game-specific layer in C++
as well. This layer includes the main entry point for the game,
creates all the required systems and providers some game-specific
helper functions. However, this is pretty much up to you if you
wish to do so; the systems creationg could easily be lifted from
the C++ code and done in Lua.</p>

<h2 id="exposure">Exposure</h2>

<p>In order to use all the underlying C++ stuff, it has to be
“exposed” to Lua first. This can be done using the interface
provided by Lua, but there’s also a number of libraries
available that make it a lot more simpler. For my purposes,
I chose LuaBridge for its simple usage and sufficient feature
set. Bear in mind that while the features were more than enough
for <em>me</em>, you should do a comparison between the libraries
before getting your hands dirty with LuaBridge or any alternatives.
One thing that’s <em>almost</em> an issue for me is that C++ classes
cannot be inherited in Lua using LuaBridge. It could make
some situations easier, but I personally think that it keeps
the Lua scripts a bit cleaner.</p>

<p>Anyhoo, no matter which utility library you choose, you have to
expose all the stuff you want to use. This means that Lua has
to be aware of the things that are available in C++ and how
to use that stuff. In my case, I wrote a helper class called
<code class="highlighter-rouge">LuaExposer</code> that exposes all the stuff that is needed. This
exposure code looks like this:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// This exposes the class 'Tecs::World' to Lua (L is the lua_State*)
// and two of its functions called "createEntity" and "deleteEntity"
</span><span class="n">getGlobalNamespace</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="p">.</span><span class="n">beginClass</span><span class="o">&lt;</span><span class="n">Tecs</span><span class="o">::</span><span class="n">World</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"World"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addFunction</span><span class="p">(</span><span class="s">"createEntity"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Tecs</span><span class="o">::</span><span class="n">World</span><span class="o">::</span><span class="n">createEntity</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addFunction</span><span class="p">(</span><span class="s">"deleteEntity"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Tecs</span><span class="o">::</span><span class="n">World</span><span class="o">::</span><span class="n">deleteEntity</span><span class="p">)</span>
    <span class="p">.</span><span class="n">endClass</span><span class="p">();</span>

<span class="c1">// This exposes the class 'Tecs::Entity' to Lua
</span><span class="n">getGlobalNamespace</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
    <span class="p">.</span><span class="n">beginClass</span><span class="o">&lt;</span><span class="n">Tecs</span><span class="o">::</span><span class="n">Entity</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Entity"</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addFunction</span><span class="p">(</span><span class="s">"getID"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Tecs</span><span class="o">::</span><span class="n">Entity</span><span class="o">::</span><span class="n">getId</span><span class="p">)</span>
    <span class="p">.</span><span class="n">endClass</span><span class="p">();</span></code></pre></figure>

<p>This all is rather simple: you can create classes, give them names,
and map functions and data to class members. You can also
expose constructors so you can create new C++ objects in
Lua scripts. The great thing about this is that you can have
“Lua lifetime” for your C++ objects - they get automatically
garbage-collected when they get out of scope.</p>

<p>Now, the engine exposes a nautical ton of stuff like in the
code above. There’s Tecs, there’s lots of components like
<code class="highlighter-rouge">PhysicsBody</code>, <code class="highlighter-rouge">Sprite</code> and <code class="highlighter-rouge">SpriteAnimation</code>. GLM is also
exposed so that the math structs can be used in Lua. I wanted
to keep some parts of the code “C++ only” so I did not expose
the constructor or <code class="highlighter-rouge">Tecs::World</code>. Instead, the one and only
World objects is created in the game-specific C++ layer.
In the game-specific layer, I added a number of helper functions
to add components to entities like this:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="mi">4</span>
<span class="mi">5</span>
<span class="mi">6</span>
<span class="mi">7</span>
<span class="mi">8</span>
<span class="mi">9</span>
<span class="mi">10</span>
<span class="mi">11</span>
<span class="mi">12</span>
<span class="mi">13</span>
<span class="mi">14</span>
<span class="c1">// Adds a sprite component to the given entity.
</span><span class="n">Sprite</span><span class="o">&amp;</span> <span class="n">LuaHelper</span><span class="o">::</span><span class="n">addSprite</span><span class="p">(</span><span class="n">Entity</span><span class="o">&amp;</span> <span class="n">entity</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">spritename</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">entity</span><span class="p">.</span><span class="n">addComponent</span><span class="o">&lt;</span><span class="n">Sprite</span><span class="o">&gt;</span><span class="p">(</span><span class="n">AssetManager</span><span class="o">::</span><span class="n">loadTexture</span><span class="p">(</span><span class="n">spritename</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="c1">// Exposes the helper functions
</span><span class="kt">void</span> <span class="n">LuaHelper</span><span class="o">::</span><span class="n">expose</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">getGlobalNamespace</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="p">.</span><span class="n">beginClass</span><span class="o">&lt;</span><span class="n">LuaHelper</span><span class="o">&gt;</span><span class="p">(</span><span class="s">"Helper"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">addStaticFunction</span><span class="p">(</span><span class="s">"addSprite"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">LuaHelper</span><span class="o">::</span><span class="n">addSprite</span><span class="p">)</span>
        <span class="p">.</span><span class="n">endClass</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>Great! Now we have stuff exposed to Lua and some helper stuff to
make life a bit easier.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Implementing a Lua scripting support to your C++ game code
is a rather simple task. When you want to use any stuff
written in C++ in your Lua scripts, you first have to “expose”
them to Lua. After that, scripting is enabled and can speed
up your development tremendously.</p>

<p><a href="http://manabreak.eu/gamedev/2015/09/05/lua-and-cpp-part-2.html">In the second part</a>, I’ll show you how to get cracking with the actual
scripts and make your game a bit more lively.</p>

<p>If you found this article helpful and want to see more stuff
like this, <a href="http://ko-fi.com/?i=9152LY80MBJF">buy me a cup of coffee</a> - it fuels my writing
and makes this all possible. And you know, I’m broke.</p>

    </article>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- fyi - post - bottom -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-3632636155475507"
         data-ad-slot="5770517898"
         data-ad-format="auto"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

</div>

            </div>
        </div>

        <div class="wrapper">
    <footer class="site-footer">

        <div class="coffee-wrapper">
            <a href='http://ko-fi.com?i=9152LY80MBJF' target='_blank' class="coffee-link">
                <img style='border:0px' width="150px" src='https://az743702.vo.msecnd.net/cdn/btn1.png' border='0' alt='Buy Me A Coffee at Ko-Fi.com' class="coffee-img"/>
            </a> 
        </div>
        
        
        <div class="some-wrapper">
            <a href="https://twitter.com/dManabreak">
                <span class="icon  icon--twitter">
                    <svg viewBox="0 0 16 16">
                    <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                          c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                    </svg>
                </span>

                <span class="username">dManabreak</span>
            </a>
        </div>
        

        <p class="rss-subscribe">subscribe <a href="/feed.xml">via RSS</a></p>

        

    </footer>
</div>


    </body>

</html>
